<!DOCTYPE html>
<html lang="en-US">
<head>
<title> dashboard </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
<script src="https://apis.google.com/js/platform.js" async defer></script>
<meta name="google-signin-client_id" content="594095535210-c0svg0rb0ulj6l477jr07f2saj24q98v.apps.googleusercontent.com">
<meta name="google-signin-cookiepolicy" content="single_host_origin">
<meta name="google-signin-scope" content="profile email">

<style>
body {
    font-family: Arial, sans-serif;
}
.row {
  display: table-row;
}
.column {
  float: left;
  width: 50%;
  display: table-cell;
}
.left {
  width: 34%;
}
.right {
  width: 66%;
}

#mainTable {
  float: right;
}
tr.project {
  cursor: zoom-in;
}
th {
    font-size: 24pt;
    color: #4c7ece;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}
</style>

<body>
<div id="app">
<div class="row">
 <div class="column left">
   <table id="mainTable">
   <th colspan="2"> dashboard </th>
   </table>
    <hr>
    t2
    <table>
        <tr v-for="(v, k) in vdocs2" class="project">
          <td> <span v-html="v.statusHTML"></span> </td> <td> {{ k }} </td>
        </tr>
    </table>
 </div>
 <div class="column right" id="details">
  {{ alldetails }}
 </div>
</div>

<div class="userstatus"> {{ userstatus }} </div>
<div class="g-signin2" data-onsuccess="onSignIn"></div>
<br>
<button onclick="writeData()"> write data </button>
<h5> 
{{ versionMessage }}
</h5>
</div>

<script>
    var app = new Vue( {
        el: "#app",
        data: {
            vdocs: [],
            vdocs2: {},
            alldetails: "none",
            versionMessage: " Thu Jan  3 14:22:42 CST 2019",
            userstatus: "public read-only"
        }
    });

  var G = {
    "desc": { },     // place to store project descriptions
    "detailsMD": { }     // project details markdown
  };

  var icons = {
    'green':    'assets/ok.png',
    'yellow':   'assets/error.png',
    'red':      'assets/close-window.png',
    'todo':     'assets/under-construction.png',
    'working':  'assets/in-progress.png',
    'sleeping': 'assets/sleeping.png'
  };
  function iconHTML( s ) {
    return `<img src="${icons[s]}" alt="${s}">`;
  }

  function mainTable (alldocs) {
    e = document.getElementById("mainTable")  // TODO: if null
    alldocs.forEach((doc) => {
      app.vdocs.push( {
        "id": doc.id, 
        "status": doc.data().status,
        "statusHTML": `<img src="${icons[ doc.data().status ]}" alt="${ doc.data().status }">`,
        "description": doc.data().description,
        } );
      app.vdocs2[ doc.id ] = {
        status: doc.data().status,
        statusHTML: `<img src="${icons[ doc.data().status ]}" alt="${ doc.data().status }">`,
        description: doc.data().description,
        };
      console.log(doc.id);
      G['desc'][doc.id] = doc.data().description; 
      G['detailsMD'][doc.id] = doc.data().detailsMD; 
      let html = `<tr class="project" onclick="showDetails('${doc.id}')"> <td> ${iconHTML(doc.data().status)} </td> <td> ${doc.id} </td> </tr>`;
      e.insertAdjacentHTML( 'beforeend', html )
    });
  }
  function showDetails(p) {
    console.log(`showDetails ${p}`);
    e = document.getElementById("details");  // TODO: if null
    //let desc = ('desc' in G[p]) ? G[p]['desc'] : "";
    let desc = G['desc'][p];
    let detailsMD = G['detailsMD'][p];
    e.innerHTML = `<br><br> details of <i> ${p} </i> <br> <br> ${desc} <br> <br> ${detailsMD}`;
  }

  var config = {
    apiKey: "AIzaSyCGlXExjEJPYbPAbTrrS4EeNoSwryTL2Hc",
    authDomain: "netrcdashboard.firebaseapp.com",
    databaseURL: "https://netrcdashboard.firebaseio.com",
    projectId: "netrcdashboard",
    storageBucket: "netrcdashboard.appspot.com",
    messagingSenderId: "594095535210"
  };
  firebase.initializeApp(config);

  var fs = firebase.firestore();
  console.log("projects get");
  fs.collection('projects').get()
    .then( mainTable )
    .catch((err) => {
      console.log('Error getting documents', err);
    });

  ////////////////////////////////////////////////
  // https://developers.google.com/identity/sign-in/web/sign-in
  function onSignIn(googleUser) {
    var profile = googleUser.getBasicProfile();
    console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
    console.log('Name: ' + profile.getName());
    console.log('Image URL: ' + profile.getImageUrl());
    console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.


  // https://firebase.google.com/docs/auth/web/google-signin
  // We need to register an Observer on Firebase Auth to make sure auth is initialized.
  var unsubscribe = firebase.auth().onAuthStateChanged(function(firebaseUser) {
    unsubscribe();

    // my code here: get roles; hide signin; show signout; 
    console.log(`f u uid: ${firebaseUser.uid}`);
    fs.collection("userInfo").doc(firebaseUser.uid).get().then(function(doc) {
        if (doc.exists) { // doc shouldn't exist for other users
            console.log("Document data:", doc.data());
            // already says 'public read-only'; update only for admin
            if ("roles" in doc.data()) {
                if ("admin" in doc.data()["roles"]) {
                    app.userstatus = "admin r/w"
                }
            }
        } else {
            // doc.data() will be undefined in this case
            console.log("userinfo - No such document!");
        }
    }).catch(function(error) {
        console.log("Error getting userinfo document:", error);
    });
    ///////

    // Check if we are already signed-in Firebase with the correct user.
    if (!isUserEqual(googleUser, firebaseUser)) {
      // Build Firebase credential with the Google ID token.
      var credential = firebase.auth.GoogleAuthProvider.credential(
          googleUser.getAuthResponse().id_token);
      // Sign in with credential from the Google user.
      firebase.auth().signInAndRetrieveDataWithCredential(credential).catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // The email of the user's account used.
        var email = error.email;
        // The firebase.auth.AuthCredential type that was used.
        var credential = error.credential;
        // ...
      });

    } else {
      console.log('User already signed-in Firebase.');
    }
  });

  }
  function isUserEqual(googleUser, firebaseUser) {
      if (firebaseUser) {
        var providerData = firebaseUser.providerData;
        for (var i = 0; i < providerData.length; i++) {
          if (providerData[i].providerId === firebase.auth.GoogleAuthProvider.PROVIDER_ID && providerData[i].uid === googleUser.getBasicProfile().getId()) {
            // We don't need to reauth the Firebase connection.
            return true;
          }
       }
     }
     return false;
  }
  ////////////////////////////////////////////////

function writeData() {
    console.log("write data");
    updateDoc = { "status": "yellow", "date": Date().toString() };
  //fs.collection('projects').get()
    //.then( mainTable )
    //.catch((err) => {
      //console.log('Error getting documents', err);
    //});
    fs.collection("projects").doc("testP").set(updateDoc)
        .then(function() {
            console.log("Document successfully written!");
        })
        .catch(function(error) {
            console.error("Error writing document: ", error);
        });
}

</script>

</body>

</html>
